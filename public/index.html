<!DOCTYPE html>
<html>
<body>
  <video id="remoteVideo" autoplay playsinline></video>

  <script>
    const ws = new WebSocket("wss://webrtc-signaling-server-va4t.onrender.com");
    let pc = null;

    ws.onopen = () => {
      ws.send(JSON.stringify({ role: "browser" }));
    };

    ws.onmessage = async (e) => {
      const msg = JSON.parse(e.data);

      // ====== OFFER 受信 ======
      if (msg.type === "offer") {
        pc = new RTCPeerConnection({
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" }
          ]
        });

        // 映像トラックを取得
        pc.ontrack = (ev) => {
          document.getElementById("remoteVideo").srcObject = ev.streams[0];
        };

        // ICE candidate を Unity に送る
        pc.onicecandidate = (ev) => {
          if (ev.candidate) {
            ws.send(JSON.stringify({
              type: "candidate",
              candidate: ev.candidate.candidate,
              sdpMid: ev.candidate.sdpMid,
              sdpMLineIndex: ev.candidate.sdpMLineIndex,
            }));
          }
        };

        // オファー処理
        await pc.setRemoteDescription(
          new RTCSessionDescription({ type: "offer", sdp: msg.sdp })
        );

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        // Answer を Unity に送信
        ws.send(JSON.stringify({
          type: "answer",
          sdp: answer.sdp,
        }));
      }

      // ====== ICE candidate 受信 ======
      if (msg.type === "candidate" && pc) {
        await pc.addIceCandidate({
          candidate: msg.candidate,
          sdpMid: msg.sdpMid,
          sdpMLineIndex: msg.sdpMLineIndex,
        });
      }
    };
  </script>
</body>
</html>
