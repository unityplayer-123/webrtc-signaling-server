<script>
let pc = null;
let ws = new WebSocket("wss://webrtc-signaling-server-va4t.onrender.com");

ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);

    // Unity → Browser: Offer
    if (msg.type === "offer") {

        pc = new RTCPeerConnection({
            iceServers: [
                { urls: "stun:stun.relay.metered.ca:80" },
                {
                    urls: [
                        "turn:standard.relay.metered.ca:80",
                        "turn:standard.relay.metered.ca:80?transport=tcp",
                        "turn:standard.relay.metered.ca:443",
                        "turns:standard.relay.metered.ca:443?transport=tcp"
                    ],
                    username: "122d34ed058124a8f4651057",
                    credential: "T/tLmU7aLcvuABaW"
                }
            ]
        });

        pc.ontrack = (e) => {
            document.querySelector("#video").srcObject = e.streams[0];
        };

        pc.onicecandidate = (ice) => {
            if (ice.candidate) {
                ws.send(JSON.stringify({
                    type: "candidate",
                    candidate: ice.candidate.candidate,
                    sdpMid: ice.candidate.sdpMid,
                    sdpMLineIndex: ice.candidate.sdpMLineIndex
                }));
            }
        };

        await pc.setRemoteDescription({ type: "offer", sdp: msg.sdp });

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        ws.send(JSON.stringify({
            type: "answer",
            sdp: answer.sdp
        }));
    }

    // Unity → Browser: Ice Candidate
    if (msg.type === "candidate") {
        try {
            await pc.addIceCandidate({
                candidate: msg.candidate,
                sdpMid: msg.sdpMid,
                sdpMLineIndex: msg.sdpMLineIndex
            });
        } catch (e) { }
    }
};
</script>

<video id="video" autoplay playsinline controls></video>
